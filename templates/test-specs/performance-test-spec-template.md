# {{FEATURE_NAME}} - 性能テスト仕様書

## テスト情報

- **機能名**: {{FEATURE_NAME}}
- **作成日時**: {{CREATED_AT}}
- **テストタイプ**: 性能テスト（Performance Test）

## テスト目的

<!-- このテストで検証したい内容を記述してください -->
- システムが要求される性能要件を満たすことを確認
- 高負荷時のシステム挙動を検証
- ボトルネックを特定し、改善ポイントを明確化
- 本番環境での予想される負荷に耐えられるかを確認

## 性能要件

### 非機能要件

| 項目 | 目標値 | 許容値 | 測定方法 |
|------|--------|--------|---------|
| レスポンスタイム（平均） | 200ms以下 | 500ms以下 | 95パーセンタイル |
| レスポンスタイム（最大） | 1秒以下 | 2秒以下 | 99パーセンタイル |
| スループット | 1000 RPS | 800 RPS | 同時リクエスト数 |
| エラー率 | 0.1%以下 | 1%以下 | 失敗リクエスト数 / 総リクエスト数 |
| CPU使用率 | 70%以下 | 85%以下 | サーバーメトリクス |
| メモリ使用率 | 80%以下 | 90%以下 | サーバーメトリクス |

## テストシナリオ

### 1. 負荷テスト（Load Test）

**目的**: 通常時の負荷でシステムが正常に動作することを確認

**テスト条件**:
- **同時ユーザー数**: 100人
- **テスト時間**: 30分
- **リクエスト間隔**: 1秒
- **負荷パターン**: 一定

**テストケース**:

| テストケースID | APIエンドポイント | HTTPメソッド | 期待レスポンスタイム | 期待スループット |
|--------------|-----------------|------------|------------------|---------------|
| PT-L-001 | `/api/users` | GET | < 200ms | > 100 RPS |
| PT-L-002 | `/api/products` | GET | < 300ms | > 100 RPS |
| PT-L-003 | `/api/orders` | POST | < 500ms | > 50 RPS |

**成功基準**:
- [ ] 全リクエストが成功する（エラー率 < 0.1%）
- [ ] 平均レスポンスタイムが目標値以内
- [ ] CPU/メモリ使用率が許容範囲内

### 2. ストレステスト（Stress Test）

**目的**: システムの限界を特定し、高負荷時の挙動を確認

**テスト条件**:
- **同時ユーザー数**: 100人から徐々に増加（最大 500人）
- **テスト時間**: 60分
- **負荷パターン**: 段階的増加（10分ごとに100人ずつ増加）

**負荷増加パターン**:

```
100人 → 200人 → 300人 → 400人 → 500人
  0min   10min   20min   30min   40min   50min
```

**期待される結果**:
- [ ] どの時点でシステムが限界に達するかを特定
- [ ] エラー率が急増するポイントを記録
- [ ] システムがクラッシュせずにグレースフルデグラデーションする

### 3. スパイクテスト（Spike Test）

**目的**: 急激な負荷増加時のシステムの回復力を確認

**テスト条件**:
- **ベースライン**: 50人
- **スパイク**: 500人（10秒間）
- **回復時間**: 5分
- **繰り返し**: 3回

**スパイクパターン**:

```
 50人 → 500人 → 50人 → 500人 → 50人 → 500人 → 50人
  0min   5min  5min10s 10min 10min10s 15min 15min10s 20min
```

**成功基準**:
- [ ] スパイク時にシステムがクラッシュしない
- [ ] スパイク後に正常なレスポンスタイムに回復する
- [ ] エラー率がスパイク後に許容範囲内に戻る

### 4. 持久力テスト（Endurance Test）

**目的**: 長時間稼働時のメモリリークやリソース枯渇がないことを確認

**テスト条件**:
- **同時ユーザー数**: 200人（一定）
- **テスト時間**: 24時間
- **モニタリング間隔**: 1分

**監視項目**:
- [ ] メモリ使用量が時間経過とともに増加していないか
- [ ] レスポンスタイムが徐々に悪化していないか
- [ ] データベースコネクションプールがリークしていないか
- [ ] ログファイルのサイズが無制限に増加していないか

## テストツール

### 推奨ツール

- **k6**: シナリオベースの負荷テスト（推奨）
- **Apache JMeter**: GUI ベースの負荷テスト
- **Gatling**: Scala ベースの高性能負荷テスト
- **Locust**: Python ベースの分散負荷テスト

### モニタリングツール

- **Prometheus + Grafana**: メトリクス収集・可視化
- **New Relic / Datadog**: APM（Application Performance Monitoring）
- **AWS CloudWatch / GCP Monitoring**: クラウドネイティブ監視

## テストスクリプト例（k6）

```javascript
import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  stages: [
    { duration: '5m', target: 100 },  // ramp-up
    { duration: '30m', target: 100 }, // stay
    { duration: '5m', target: 0 },    // ramp-down
  ],
  thresholds: {
    http_req_duration: ['p(95)<500'], // 95% of requests < 500ms
    http_req_failed: ['rate<0.01'],   // error rate < 1%
  },
};

export default function () {
  const response = http.get('http://test-api/api/users');

  check(response, {
    'status is 200': (r) => r.status === 200,
    'response time < 500ms': (r) => r.timings.duration < 500,
  });

  sleep(1);
}
```

## テスト環境

### インフラストラクチャ

- **アプリケーションサーバー**:
  - CPU: 4 cores
  - Memory: 16GB
  - OS: Linux（本番環境と同等）

- **データベースサーバー**:
  - CPU: 8 cores
  - Memory: 32GB
  - Storage: SSD

- **ロードバランサー**: Nginx / ALB

### ネットワーク

- **レイテンシ**: 本番環境と同等に設定
- **帯域幅**: 十分な帯域を確保
- **クライアント分散**: 複数リージョンからリクエスト

## テストデータ

### データ量

- **ユーザー数**: 100,000件
- **商品数**: 10,000件
- **注文履歴**: 500,000件

### データ分布

- アクティブユーザー: 20%
- 人気商品: 上位10%が80%のアクセスを占める（パレートの法則）

## 実行手順

### 事前準備

```bash
# テストデータの投入
npm run db:seed:performance

# アプリケーションの起動（本番モード）
npm run start:production

# モニタリングツールの起動
docker-compose up -d prometheus grafana
```

### テスト実行

```bash
# 負荷テスト実行
k6 run --vus 100 --duration 30m load-test.js

# ストレステスト実行
k6 run --stage "10m:100,10m:200,10m:300,10m:400,10m:500" stress-test.js

# スパイクテスト実行
k6 run spike-test.js

# 持久力テスト実行
k6 run --vus 200 --duration 24h endurance-test.js
```

### 結果収集

```bash
# k6の結果をPrometheusに送信
k6 run --out prometheus=localhost:9090 load-test.js

# Grafanaで結果を可視化
# http://localhost:3000
```

## 結果分析

### 確認項目

- [ ] 全テストシナリオが成功基準を満たす
- [ ] ボトルネックが特定された場合、原因を記録
- [ ] 性能改善が必要な箇所をリストアップ
- [ ] スケーリング戦略を提案

### レポート項目

- 各シナリオの結果サマリー
- レスポンスタイム分布図
- エラー率の推移
- リソース使用率のグラフ
- ボトルネック分析
- 改善提案

## 変更履歴

| 日付 | 変更者 | 変更内容 |
|------|-------|---------|
| {{CREATED_AT}} | - | 初版作成 |
