# {{FEATURE_NAME}} - セキュリティテスト仕様書

## テスト情報

- **機能名**: {{FEATURE_NAME}}
- **作成日時**: {{CREATED_AT}}
- **テストタイプ**: セキュリティテスト（Security Test）

## テスト目的

<!-- このテストで検証したい内容を記述してください -->
- OWASP Top 10 の脆弱性が存在しないことを確認
- 認証・認可メカニズムが適切に機能することを検証
- データの機密性・完全性が保護されていることを確認
- セキュリティインシデントに対する耐性を評価

## セキュリティ要件

### 準拠すべき基準

- [ ] **OWASP Top 10 (2021)**: Web アプリケーションの主要な脆弱性に対する防御
- [ ] **CWE Top 25**: 最も危険なソフトウェアの脆弱性への対応
- [ ] **PCI DSS**: クレジットカード情報を扱う場合（該当する場合）
- [ ] **GDPR / 個人情報保護法**: 個人情報の適切な取り扱い

## テストカテゴリ

### 1. 認証・認可テスト

#### 1.1 認証テスト

| テストケースID | テスト項目 | 攻撃シナリオ | 期待結果 | 優先度 |
|--------------|----------|-----------|---------|-------|
| ST-AUTH-001 | パスワード強度 | 弱いパスワードで登録 | 登録が拒否される | 高 |
| ST-AUTH-002 | ブルートフォース対策 | 連続ログイン失敗 | アカウントロック or CAPTCHA | 高 |
| ST-AUTH-003 | セッション固定攻撃 | セッションIDを事前に設定 | ログイン後にセッションIDが変更される | 高 |
| ST-AUTH-004 | セッションタイムアウト | 長時間放置後にアクセス | セッション切れでログイン画面へ | 中 |

#### 1.2 認可テスト

| テストケースID | テスト項目 | 攻撃シナリオ | 期待結果 | 優先度 |
|--------------|----------|-----------|---------|-------|
| ST-AUTHZ-001 | 権限昇格 | 一般ユーザーが管理者機能にアクセス | 403 Forbidden | 高 |
| ST-AUTHZ-002 | 水平権限侵害 | 他ユーザーのデータにアクセス | 403 Forbidden | 高 |
| ST-AUTHZ-003 | JWTトークン改ざん | トークンの署名を無効化 | 認証失敗 | 高 |

### 2. インジェクション攻撃テスト

#### 2.1 SQLインジェクション

| テストケースID | テスト項目 | 攻撃ペイロード | 期待結果 | 優先度 |
|--------------|----------|-------------|---------|-------|
| ST-INJ-001 | SQLインジェクション（基本） | `' OR '1'='1` | エラー or エスケープされる | 高 |
| ST-INJ-002 | SQLインジェクション（Union） | `' UNION SELECT * FROM users--` | エラー or エスケープされる | 高 |
| ST-INJ-003 | SQLインジェクション（Blind） | `' AND SLEEP(5)--` | 遅延が発生しない | 中 |

#### 2.2 XSS（クロスサイトスクリプティング）

| テストケースID | テスト項目 | 攻撃ペイロード | 期待結果 | 優先度 |
|--------------|----------|-------------|---------|-------|
| ST-XSS-001 | Reflected XSS | `<script>alert('XSS')</script>` | サニタイズされる | 高 |
| ST-XSS-002 | Stored XSS | コメント欄にスクリプト投稿 | エスケープして表示 | 高 |
| ST-XSS-003 | DOM-based XSS | URLパラメータにスクリプト | エスケープされる | 中 |

#### 2.3 コマンドインジェクション

| テストケースID | テスト項目 | 攻撃ペイロード | 期待結果 | 優先度 |
|--------------|----------|-------------|---------|-------|
| ST-CMD-001 | OSコマンドインジェクション | `; ls -la` | コマンドが実行されない | 高 |
| ST-CMD-002 | パストラバーサル | `../../etc/passwd` | ファイルが読み取れない | 高 |

### 3. CSRF（クロスサイトリクエストフォージェリ）

| テストケースID | テスト項目 | 攻撃シナリオ | 期待結果 | 優先度 |
|--------------|----------|-----------|---------|-------|
| ST-CSRF-001 | CSRFトークン不在 | トークンなしでPOSTリクエスト | 403 Forbidden | 高 |
| ST-CSRF-002 | CSRFトークン改ざん | 不正なトークンでリクエスト | 403 Forbidden | 高 |

### 4. データ漏洩テスト

| テストケースID | テスト項目 | 攻撃シナリオ | 期待結果 | 優先度 |
|--------------|----------|-----------|---------|-------|
| ST-LEAK-001 | センシティブデータ露出 | エラーメッセージにスタックトレース | 詳細情報が含まれない | 高 |
| ST-LEAK-002 | APIレスポンス過剰 | 不要なユーザー情報の取得 | 必要最小限のデータのみ | 中 |
| ST-LEAK-003 | ディレクトリリスティング | `/uploads/` にアクセス | 403 or ファイル一覧非表示 | 中 |

### 5. 暗号化テスト

| テストケースID | テスト項目 | 検証内容 | 期待結果 | 優先度 |
|--------------|----------|---------|---------|-------|
| ST-CRYPT-001 | パスワードハッシュ化 | DBのパスワードフィールド | bcrypt/Argon2等で暗号化 | 高 |
| ST-CRYPT-002 | 通信暗号化 | HTTP vs HTTPS | HTTPS必須 | 高 |
| ST-CRYPT-003 | セッションCookie | Secure/HttpOnly属性 | 両方が設定されている | 高 |

### 6. API セキュリティテスト

| テストケースID | テスト項目 | 攻撃シナリオ | 期待結果 | 優先度 |
|--------------|----------|-----------|---------|-------|
| ST-API-001 | レート制限 | 短時間に大量リクエスト | 429 Too Many Requests | 中 |
| ST-API-002 | APIキーの検証 | 不正なAPIキーでリクエスト | 401 Unauthorized | 高 |
| ST-API-003 | Mass Assignment | 許可されていないフィールドを更新 | 更新が拒否される | 中 |

## 自動化スキャンツール

### SAST（Static Application Security Testing）

- **SonarQube**: コード品質 + セキュリティスキャン
- **Checkmarx / Fortify**: 商用 SAST ツール
- **Semgrep**: オープンソース静的解析

### DAST（Dynamic Application Security Testing）

- **OWASP ZAP**: オープンソース脆弱性スキャナー（推奨）
- **Burp Suite**: ペネトレーションテスト用プロキシツール
- **Nikto**: Webサーバースキャナー

### 依存関係スキャン

- **Snyk**: 依存ライブラリの脆弱性スキャン
- **Dependabot**: GitHub 統合の自動更新
- **npm audit / yarn audit**: Node.js 依存関係スキャン

## テスト実行手順

### OWASP ZAP による自動スキャン

```bash
# ZAPをDockerで起動
docker run -v $(pwd):/zap/wrk/:rw -t owasp/zap2docker-stable zap-baseline.py \
  -t http://test-target-url \
  -r zap-report.html

# スパイダーでクロール + アクティブスキャン
docker run -v $(pwd):/zap/wrk/:rw -t owasp/zap2docker-stable zap-full-scan.py \
  -t http://test-target-url \
  -r zap-full-report.html
```

### Snyk による依存関係スキャン

```bash
# Snyk CLI インストール
npm install -g snyk

# ログイン
snyk auth

# 脆弱性スキャン
snyk test

# 自動修正提案
snyk wizard
```

### 手動ペネトレーションテスト

1. **情報収集**: Nmap, Whois, DNS enumeration
2. **脆弱性スキャン**: OWASP ZAP, Burp Suite
3. **エクスプロイト試行**: Metasploit（許可された環境のみ）
4. **レポート作成**: 発見した脆弱性と影響度を文書化

## テスト環境

### テスト対象環境

- **ステージング環境**: 本番と同等の構成
- **分離されたテスト環境**: 破壊的テスト用
- **本番環境**: 受動的スキャンのみ（許可が必要）

### 注意事項

- **DoS攻撃テストは禁止**: 可用性に影響を与えるテストは実施しない
- **データ保護**: テストデータに実データを使用しない
- **スコープ遵守**: 承認されたスコープ内でのみテストを実施

## セキュリティチェックリスト

### 実装時チェックリスト

- [ ] 入力値は全てサーバーサイドで検証している
- [ ] SQLクエリはプリペアドステートメントを使用
- [ ] HTMLエスケープ処理を実装
- [ ] CSRFトークンを全てのフォームに設定
- [ ] パスワードはbcrypt/Argon2でハッシュ化
- [ ] HTTPSを強制している
- [ ] Cookieに Secure/HttpOnly/SameSite 属性を設定
- [ ] APIレート制限を実装
- [ ] エラーメッセージに機密情報を含まない
- [ ] ログに機密情報を出力しない

### デプロイ前チェックリスト

- [ ] 全セキュリティテストがパス
- [ ] OWASP ZAP スキャンで Critical/High なし
- [ ] 依存ライブラリに既知の脆弱性なし
- [ ] セキュリティヘッダーが適切に設定
- [ ] 本番環境のAPIキー・シークレットが安全に管理されている

## インシデント対応

### 脆弱性が発見された場合

1. **深刻度評価**: CVSS スコアで評価（Low/Medium/High/Critical）
2. **影響範囲特定**: どのシステム・データが影響を受けるか
3. **修正計画**: 修正方法と優先度を決定
4. **修正実装**: パッチ適用 or コード修正
5. **再テスト**: 修正後に脆弱性が解消されたことを確認
6. **報告**: ステークホルダーへの報告（必要に応じて）

## 参考資料

- **OWASP Top 10**: https://owasp.org/www-project-top-ten/
- **CWE Top 25**: https://cwe.mitre.org/top25/
- **OWASP Testing Guide**: https://owasp.org/www-project-web-security-testing-guide/
- **NIST Cybersecurity Framework**: https://www.nist.gov/cyberframework

## 変更履歴

| 日付 | 変更者 | 変更内容 |
|------|-------|---------|
| {{CREATED_AT}} | - | 初版作成 |
