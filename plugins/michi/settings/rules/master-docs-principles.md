# Master Docs更新原則

## 目的

`{{REPO_ROOT_DIR}}/docs/master/` を永続的なプロジェクト知識（Project Memory）として維持する。パターンと原則を捉え、コードベースとの整合性を保ちながら、ユーザーのカスタマイズを保護する。

## 適用場面

- `/michi:update-master-docs` コマンド実行時
- プロジェクト開始時（Bootstrap）
- コードベース変更時の同期（Sync）
- 新規メンバーのオンボーディング時
- 設計判断の参照時

## ルール詳細

### 1. Master Docsの役割

**永続的なプロジェクトメモリ**:
- コードベースの変更があっても残る知識
- 設計判断、アーキテクチャパターン、技術選定理由
- 新規メンバーが最初に読むべきドキュメント
- AIエージェントがコンテキストとして読み込む

**Source of Truth**:
- プロジェクトの「なぜ」「どのように」を文書化
- 暗黙知を形式知に変換
- 決定の背景と理由を保存

### 2. パターンと原則の文書化

**ゴールデンルール**:
> 「新しいコードが既存のパターンに従っている場合、Master Docsを更新する必要はない。」

**パターン重視**:
- **良い例**: 例を交えて構成パターンを説明
- **悪い例**: ディレクトリツリー内のすべてのファイルをリスト化

**原則重視**:
- **良い例**: API設計の原則（RESTful、命名規則）
- **悪い例**: すべてのAPIエンドポイントのリスト

### 3. 粒度の原則

**網羅的なリストではなく、パターンと原則**:
- カタログ（Catalog）ではない
- パターン（Pattern）とガイドライン（Guideline）
- 例（Example）と理由（Rationale）

**適切な粒度**:
- **コア情報**: プロダクト概要、アーキテクチャ、技術スタック
- **開発規約**: API設計、データモデル
- **運用知識**: デプロイ、監視、トラブルシューティング
- **意思決定記録**: ADR（Architecture Decision Record）

### 4. Bootstrapモード（初回生成）

**トリガー**:
- `{{REPO_ROOT_DIR}}/docs/master/` が空
- コアファイル（product.md, architecture.md, tech-stack.md, structure.md, sequence.md）が存在しない

**実行手順**:
1. `{{MICHI_DIR}}/settings/templates/master-docs/` からテンプレートを読み込む
2. コードベースを分析（JIT - Just In Time）:
   - `glob_file_search` でソースファイルを検索
   - `read_file` でREADME、package.json等を読み込む
   - `grep` でパターンを検索
3. パターンを抽出（リストではない）:
   - Product: 目的、価値、コア機能
   - Architecture: システム構成、コンポーネント関係
   - Tech: フレームワーク、決定事項、規約
   - Structure: 構成、命名、インポート
   - Sequence: 主要フローのシーケンス図
4. Master Docsファイルを生成（テンプレートに従う）
5. レビュー用にサマリーを提示

**フォーカス**:
- 決定を導くパターン
- ファイルや依存関係のカタログではない

### 5. Syncモード（同期・更新）

**トリガー**:
- すべてのコアファイルが存在する
- コードベースに変更があった

**実行手順**:
1. 既存のすべてのMaster Docs（`{{REPO_ROOT_DIR}}/docs/master/**/*.md`）を読み込む
2. コードベースの変更を分析（JIT）
3. ドリフトを検出:
   - **Master Docs → Code**: 欠落している要素 → 警告
   - **Code → Master Docs**: 新しいパターン → 更新候補
   - **カスタムファイル**: 関連性をチェック
4. 更新を提案（追加的に、ユーザーコンテンツを保護）
5. レポート: 更新、警告、推奨事項

**更新の哲学**:
- **置き換えではなく追加**
- **ユーザーセクションを保護**
- **迷った場合は追加**

### 6. コンテンツの制約

**含めてはいけないもの**:
- **セキュリティ情報**: キー、パスワード、シークレット
- **エージェント固有ディレクトリ**: `.cursor/`, `.gemini/`, `.claude/`
- **Michi設定の詳細**: `{{MICHI_DIR}}/settings/` の内容（メタデータであり、プロジェクト知識ではない）
- **プロジェクト仕様の詳細**: `{{MICHI_DIR}}/pj/` の個別仕様（軽い参照は許容）
- **網羅的なファイルリスト**: すべてのファイルのリスト化

**含めるべきもの**:
- **パターン**: 構成パターン、命名パターン、設計パターン
- **原則**: API設計原則、データモデル設計原則
- **理由**: 技術選定理由、アーキテクチャ判断の背景
- **例**: 具体的な例とその説明
- **ガイドライン**: 開発ガイドライン、運用ガイドライン

### 7. JIT戦略（Just In Time）

**必要なときに取得**:
- すべてのファイルを事前に読み込まない
- 必要な情報を必要なときに取得
- ツールを効率的に使用

**推奨ツール**:
- `glob_file_search`: ソース/設定ファイルを検索
- `read_file`: Master Docs、ドキュメント、設定を読み込む
- `grep`: パターンを検索
- `list_dir`: 構造を分析

### 8. ユーザーカスタマイズの保護

**すべてのMaster Docsを平等に扱う**:
- コアファイル（core/）もカスタムファイルも同等
- ユーザーが追加したファイルを削除しない
- ユーザーが編集した内容を上書きしない

**追加的な更新**:
- 既存のセクションに追加
- 新しいセクションを作成
- ユーザーの記述を保持

**保護の原則**:
- 迷った場合は置き換えではなく追加
- 不確実な場合はユーザーに確認
- ユーザーコンテンツは神聖なもの

## 注意事項

### Master Docs構造

**必須ディレクトリ**:
```
docs/master/
├── README.md                     # このディレクトリの説明・読み方ガイド
├── core/                         # コア情報（AIが最初に読むべき）
│   ├── product.md                # プロダクト概要・目的・価値
│   ├── architecture.md           # システムアーキテクチャ全体像
│   ├── tech-stack.md             # 技術スタック・主要ライブラリ
│   ├── structure.md              # ディレクトリ構成・命名規則
│   └── sequence.md               # シーケンス図（mermaid）
├── development/                  # 開発規約
│   ├── api-design.md             # API設計原則・エンドポイント規約
│   └── data-model.md             # データモデル・スキーマ設計
├── operations/                   # 運用・保守向け
│   ├── deployment.md             # デプロイメント手順・環境情報
│   ├── monitoring.md             # 監視・アラート・メトリクス
│   ├── troubleshooting.md        # トラブルシューティングガイド
│   ├── runbook.md                # 定型運用手順書
│   └── incident-response.md      # インシデント対応フロー
├── decisions/                    # 意思決定記録
│   ├── _template.md              # ADRテンプレート
│   └── 001-example.md            # 例：技術選定理由など
└── glossary.md                   # 用語集・略語定義
```

### Bootstrap出力形式

```
✅ Master Docs作成完了

## 生成ファイル:
- core/product.md: [簡単な説明]
- core/architecture.md: [システム構成]
- core/tech-stack.md: [主要スタック]
- core/structure.md: [構成]
- core/sequence.md: [主要フロー]

Source of Truthとしてレビュー・承認してください。
```

### Sync出力形式

```
✅ Master Docs更新完了

## 変更点:
- core/tech-stack.md: React 18 → 19
- core/structure.md: APIパターンを追加

## コードドリフト:
- コンポーネントがインポート規約に従っていない

## 推奨事項:
- development/api-design.md の更新を検討
```

### エラーハンドリング

**セキュリティ**:
- キー、パスワード、シークレットを含めない
- 原則ルールを参照

**不確実性**:
- 両方の状態を報告し、ユーザーに確認
- 推測で判断しない

**保護**:
- 迷った場合は置き換えではなく追加
- ユーザーの意図を尊重

### 備考

- すべての `{{REPO_ROOT_DIR}}/docs/master/**/*.md` がプロジェクトメモリとして読み込まれる
- テンプレートと原則はカスタマイズ用に外部化されている
- カタログではなくパターンにフォーカス
- `{{MICHI_DIR}}/pj/` と `{{REPO_ROOT_DIR}}/docs/master/` への軽い参照は許容
- 他の `.michi/` ディレクトリの詳細は避ける
