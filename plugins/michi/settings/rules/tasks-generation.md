# タスク生成ルール

## 目的

承認された要件と設計を、実行可能な実装タスクに変換する。各タスクは1-3時間で完了可能な粒度に分割し、すべての要件が漏れなくカバーされることを保証する。

## 適用場面

- `/michi:create-tasks` コマンド実行時
- 実装タスク生成時
- タスク分割の判断が必要な時
- 要件から実装計画への変換時

## ルール詳細

### 1. タスク構造の原則

**階層ルール**:
- **最大2レベル**: 主要タスク（Main Task）とサブタスク（Sub-task）のみ
- **より深いネスト禁止**: サブサブタスクは作成しない
- **シーケンシャル番号付け**: 主要タスクは増分（1, 2, 3...）で番号付け、繰り返しなし

**単一サブタスク構造の折りたたみ**:
- 主要タスクが1つのサブタスクしか持たない場合、サブタスクを主要タスクに昇格
- コンテナのみの主要タスクで詳細を複製しない
- テンプレートパターンに従って適用

### 2. タスクサイズの原則

**推奨サイズ**:
- **目標**: 各サブタスクで 200-400 行の git diff
- **最大**: 500 行まで（超過時は分割を検討）
- **警告**: 400行超過時は分割を推奨

**除外対象ファイル（行数カウント対象外）**:
- ロックファイル: `package-lock.json`, `yarn.lock`, `pnpm-lock.yaml`, `composer.lock`, `Gemfile.lock`, `poetry.lock`, `Pipfile.lock`, `Cargo.lock`, `go.sum`
- 自動生成ファイル: `*.min.js`, `*.min.css`, `*.map`, `dist/*`, `build/*`, `coverage/*`, `.next/*`, `*.d.ts`, `*.generated.ts`, `__snapshots__/*`

**分割戦略**:
1. **水平分割（レイヤー別）**: model/repository → service/logic → controller/handler
2. **垂直分割（機能スライス別）**: core機能 → validation → error handling → edge cases
3. **フェーズ分割（段階別）**: 基本実装 → テスト追加 → 最適化

### 3. 要件カバレッジの原則

**完全なマッピング**:
- すべての要件を特定のタスクにマッピング
- 要件IDは数値のみをリスト（カンマ区切り）
- 説明サフィックス、括弧、翻訳、自由形式ラベルは含めない
- 不完全なカバレッジは警告を表示

**数値要件ID必須**:
- requirements.md のすべての要件は数値IDを持つ必要がある
- 要件に数値IDがない場合、停止してタスク生成前に requirements.md を修正するよう要求

### 4. タスク記述の原則

**自然言語**:
- **何をするか**を説明する（コード構造の詳細ではない）
- 能力に焦点を当てた説明
- ユーザーストーリー形式を推奨

**例**:
- 良い例: "ユーザー認証機能を実装"
- 悪い例: "AuthController.ts に authenticate() メソッドを追加"

### 5. タスク統合の原則

**システム接続**:
- すべてのタスクはシステムに接続する必要がある
- 孤立した作業は作成しない
- タスク間の依存関係を明確にする

**論理的進行**:
- タスク進行が論理的で段階的であることを確認
- 前提条件が満たされている順序でタスクを配置

### 6. テストタスクの原則

**MVP vs オプション**:
- **コア実装で満たされた受入基準**: 通常のサブタスクとして記載
- **MVP後に延期できるオプションのテストカバレッジ**: `- [ ]*` でマーク

**テスト包含**:
- すべての主要タスクはテストタスクを含む
- 単体テスト、統合テスト、E2Eテストを適切に配置

### 7. タスク生成の必須要素

**コンテキストの読み込み**:
- `project.json` - プロジェクトメタデータ
- `requirements.md` - 要件定義
- `design.md` - 設計書
- `tasks.md`（既存の場合） - マージモード用
- `docs/master/` ディレクトリ全体 - プロジェクトメモリ

**生成ルール**:
- project.json で指定された言語を使用
- すべての要件をタスクにマッピング
- すべての設計コンポーネントを含める
- 既存の tasks.md が見つかった場合、新しいコンテンツとマージ

## 注意事項

### 承認の検証

**必須承認**:
- 要件（requirements）と設計（design）が両方承認されている必要がある
- `-y` フラグで自動承認可能
- 承認されていない場合は実行停止

### エラーハンドリング

**要件または設計が欠落**:
- 実行停止
- メッセージ: "docs/michi/$1/spec/ に requirements.md または design.md が欠落しています"
- 推奨アクション: "最初に要件と設計フェーズを完了"

**不完全な要件カバレッジ**:
- 警告: "すべての要件がタスクにマッピングされていません。カバレッジをレビューしてください。"
- ユーザーアクション必要: 意図的なギャップを確認するか、タスクを再生成

**数値要件ID欠落**:
- 実行停止
- タスク生成前に requirements.md を修正するよう要求

### メタデータ更新

**project.json の更新項目**:
- `phase: "tasks-generated"` を設定
- `approvals.tasks.generated: true, approved: false` を設定
- `approvals.requirements.approved: true` を設定
- `approvals.design.approved: true` を設定
- `updated_at` タイムスタンプを更新

### 次のフェーズへの移行

**コンテキスト管理の技術的背景**:
- AIモデルには**コンテキストウィンドウ制限**（トークン上限）があります
- 会話が長くなると、チャットターンの蓄積によりコンテキストバッファが消費されます
- `/michi:dev` は Phase 6.1 で `docs/master/` からプロジェクトメモリを再ロードしますが、これは**チャット履歴の蓄積を解消しません**
- 長時間の会話履歴は、モデルの応答品質やパフォーマンスに影響する可能性があります

**会話履歴クリアのポリシー**:
- **大規模タスク時（推奨）**: 複数タスクの連続実行や長期実装セッション前にクリア
- **小規模タスク時（オプション）**: 単一の軽量タスクではクリア不要
- **クリアが推奨されるケース**:
  - 3つ以上の連続タスクを実行する前
  - 前回のセッションから多くの会話ターンが経過している場合
  - モデルの応答が遅くなったり、品質が低下したと感じた場合
- **クリアが不要なケース**:
  - 単一の小規模タスク（〜200行の変更）
  - 直前の会話ターンが少ない（〜10ターン以内）

**タスクが承認された場合**:
- 特定のタスクを実行: `/michi:dev $1 1.1`（小規模タスクならクリア不要）
- 複数のタスクを実行: `/michi:dev $1 1.1,1.2`（3タスク以上の場合はクリア推奨）
- 引数なし: `/michi:dev $1`（すべての保留中タスク - クリア推奨）

**修正が必要な場合**:
- フィードバックを提供し、`/michi:create-tasks $1` を再実行
- 既存のタスクが参照として使用される（マージモード）
