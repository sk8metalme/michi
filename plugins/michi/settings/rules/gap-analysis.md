# Gap分析フレームワーク

## 目的

要件定義と既存コードベース間の実装ギャップを体系的に分析し、設計フェーズに向けた実装戦略を策定するためのガイドライン。

## 適用場面

- `/michi:analyze-gap` コマンドでギャップ分析を実施する際
- 既存コードベースがあるブラウンフィールドプロジェクトの場合
- 要件定義完了後、設計フェーズ前の分析時

**注**: グリーンフィールドプロジェクト（新規開発）の場合はスキップ可能です。

---

## ルール詳細

### 1. Gap分析の3つの軸

Gap分析は以下の3つの観点で実施します：

#### 1.1 機能ギャップ（Functional Gap）

要件に対する実装状況を評価します。

**分析項目**:
- 実装済み機能の特定
- 部分実装機能の洗い出し
- 未実装機能の一覧化
- 既存コードの再利用可能性評価

**分析手順**:
1. `requirements.md` から全要件を抽出
2. Grep/Readツールで既存コードを検索
3. 各要件の実装状態を分類（完了/部分/欠落）
4. 実装箇所を特定（ファイル名:行番号）

#### 1.2 アーキテクチャギャップ（Architecture Gap）

設計書との整合性と技術的負債を評価します。

**分析項目**:
- 設計書との整合性チェック
- 技術的負債の検出
- パフォーマンスボトルネックの可能性
- アーキテクチャ不整合の特定

**分析手順**:
1. マスタードキュメント（structure.md、tech.md）を確認
2. 既存コードのアーキテクチャパターンを分析
3. 設計書との差異を特定
4. 技術的負債を評価（レガシーコード、非推奨API使用など）

#### 1.3 テストギャップ（Test Coverage Gap）

テストカバレッジ目標との差異を評価します。

**分析項目**:
- 現在のテストカバレッジ測定
- 欠けているテストケースの特定
- テスト戦略との整合性確認
- テスト品質の評価

**分析手順**:
1. 既存のテストコードを確認（単体/統合/E2E）
2. カバレッジレポートを参照（可能な場合）
3. 目標カバレッジ（95%）との差異を計算
4. 欠けているテストシナリオを特定

---

### 2. ギャップスコア計算方法

Gap分析の結果を定量化するために、ギャップスコアを計算します。

#### 計算式

```
ギャップスコア = (部分実装 × 0.5 + 未実装 × 1.0) / 総要件数 × 100%
```

**例**:
- 総要件数: 15
- 実装済み: 3
- 部分実装: 5
- 未実装: 7

```
ギャップスコア = (5 × 0.5 + 7 × 1.0) / 15 × 100% = 80%
```

#### スコアの解釈

| スコア範囲 | 評価 | 推奨アクション |
|-----------|------|--------------|
| 0-20% | 低ギャップ | 既存コードの拡張で対応可能 |
| 21-50% | 中ギャップ | ハイブリッドアプローチ（拡張+新規） |
| 51-80% | 高ギャップ | 新規実装中心、既存コードの部分的利用 |
| 81-100% | 超高ギャップ | ほぼ新規実装が必要 |

---

### 3. 実装アプローチの評価

Gap分析では、**複数の実行可能なアプローチ**を提示します。

#### アプローチの種類

**1. 拡張アプローチ（Extension）**
- 既存コードを拡張して要件を満たす
- 適用条件: 低〜中ギャップ、既存アーキテクチャが適切

**2. 新規アプローチ（Greenfield）**
- 新規にコンポーネントを実装
- 適用条件: 高〜超高ギャップ、既存コードの再利用が困難

**3. ハイブリッドアプローチ（Hybrid）**
- 既存コードの一部を再利用し、新規コンポーネントと組み合わせ
- 適用条件: 中〜高ギャップ、既存の基盤は活用可能

#### トレードオフの評価

各アプローチについて、以下を評価します：

- **実装工数**: 開発にかかる時間
- **技術的リスク**: 実装の難易度と不確実性
- **保守性**: 長期的な保守のしやすさ
- **パフォーマンス**: 性能面での影響
- **既存コードへの影響**: 既存機能への影響範囲

---

### 4. Gap分析レポート構造

Gap分析の結果は、以下の構造でレポートを作成します。

```markdown
# Gap Analysis Report: {feature}

## 実行サマリー

- **総要件数**: 15
- **実装済み**: 3
- **部分実装**: 5
- **未実装**: 7
- **ギャップスコア**: 80%
- **推奨アプローチ**: ハイブリッド（既存コードの基盤活用 + 新規コンポーネント）

---

## 詳細ギャップ

### 1. 機能ギャップ

| 要件ID | ステータス | 実装場所 | 備考 |
|--------|-----------|---------|------|
| REQ-001 | ✅ 完了 | src/auth/login.ts:45 | 完全に実装済み |
| REQ-002 | ⚠️ 部分 | src/auth/logout.ts:23 | エラーハンドリング欠落 |
| REQ-003 | ❌ 欠落 | - | 未実装 |
| ... | ... | ... | ... |

**総評**:
- 基本的な認証機能は実装済み
- エラーハンドリングと例外処理が不足
- セッション管理機能は未実装

---

### 2. アーキテクチャギャップ

**欠落している設計要素**:
- データベース移行戦略（既存スキーマとの統合方法が不明）
- API統合レイヤー（外部サービスとの連携設計が欠落）

**不整合**:
- エラーハンドリングアプローチ（統一されたエラー処理がない）
- ロギング戦略（ログレベルと形式が不統一）

**技術的負債**:
- auth モジュールのレガシーコード（非推奨のライブラリ使用）
- テストカバレッジ不足（45%、目標: 95%）

---

### 3. テストカバレッジギャップ

| テストタイプ | 現状 | 目標 | ギャップ |
|------------|------|------|---------|
| 単体テスト | 45% | 95% | 50% |
| 統合テスト | 欠落 | 必須 | - |
| E2Eテスト | 未実装 | 推奨 | - |

**欠けているテストシナリオ**:
- 認証フローの統合テスト
- エラーケースの単体テスト
- セッションタイムアウトのE2Eテスト

---

## 実装アプローチの評価

### アプローチ1: 拡張アプローチ

**概要**: 既存の auth モジュールを拡張し、欠落機能を追加

**メリット**:
- 既存コードの再利用により開発工数削減
- アーキテクチャの一貫性を保持

**デメリット**:
- レガシーコードの技術的負債を引き継ぐ
- リファクタリングが先行で必要

**推奨度**: ⭐⭐⭐☆☆（中）

---

### アプローチ2: 新規アプローチ

**概要**: 新規に認証モジュールを実装し、既存コードを段階的に置き換え

**メリット**:
- 技術的負債をクリーンアップ
- 最新のベストプラクティスを適用可能

**デメリット**:
- 開発工数が増大
- 既存機能への影響リスク

**推奨度**: ⭐⭐☆☆☆（低）

---

### アプローチ3: ハイブリッドアプローチ（推奨）

**概要**: 既存の基盤（データモデル、API）を活用し、新規コンポーネント（セッション管理、エラーハンドリング）を追加

**メリット**:
- バランスの取れた工数とリスク
- 段階的な改善が可能
- 既存機能への影響を最小化

**デメリット**:
- 統合の複雑さが増す

**推奨度**: ⭐⭐⭐⭐⭐（高）

---

## 推奨事項

### 優先度1（クリティカル）

実装をブロックする問題。設計フェーズで必ず対処が必要。

1. **REQ-003, REQ-005 を実装**
   - 理由: コア機能の欠落
   - 工数見積もり: 3-5日

2. **REQ-002 にエラーハンドリングを追加**
   - 理由: セキュリティリスク
   - 工数見積もり: 1-2日

---

### 優先度2（重要）

品質に影響する問題。実装中に対処が望ましい。

1. **単体テストカバレッジを95%に増加**
   - 理由: 品質保証基準
   - 工数見積もり: 3-4日

2. **レガシー auth コードをリファクタリング**
   - 理由: 技術的負債の解消
   - 工数見積もり: 2-3日

---

### 優先度3（あると良い）

実装後に改善可能。

1. **統合テストを追加**
   - 理由: 品質向上
   - 工数見積もり: 2日

2. **アーキテクチャ決定を文書化**
   - 理由: 保守性向上
   - 工数見積もり: 1日

---

## 調査が必要な領域

以下の領域は、Gap分析では結論が出なかったため、設計フェーズで包括的な調査が必要です：

1. **外部APIとの統合方法**
   - 調査項目: 認証プロトコル（OAuth2、SAML）の選定
   - 参考資料: 外部サービスのAPI仕様書

2. **データベース移行戦略**
   - 調査項目: 既存スキーマとの統合方法
   - 参考資料: データベース設計ドキュメント

3. **セッション管理の技術選定**
   - 調査項目: Redis、Memcached、JWTの比較
   - 参考資料: パフォーマンス要件

---

## 次のステップ

1. **Gap分析レポートのレビュー**: ステークホルダーと結果を共有
2. **推奨アプローチの合意**: ハイブリッドアプローチで進めることを確認
3. **設計フェーズへの移行**: `/michi:create-design {feature}` で技術設計を作成
```

---

## 注意事項

### 決定より情報

Gap分析の目的は**最終的な実装選択を決定すること**ではなく、**分析とオプションを提供すること**です。

**原則**:
- 複数の実行可能な代替案を提示
- それぞれのトレードオフを明示
- 最終決定は設計フェーズでユーザーと合意

### 徹底的な調査

Gap分析では、既存コードベースを**深く理解**することが重要です。

**推奨ツール使用**:
- **Grep**: パターン、規約、統合ポイントの検索
- **Read**: 既存コードの詳細確認
- **Glob**: 関連ファイルの一覧取得
- **WebSearch/WebFetch**: 外部依存関係とベストプラクティスの調査

### 明示的なギャップのフラグ付け

調査または検討が必要な領域は、**明確にフラグ付け**します。

**フラグ付けすべき項目**:
- 複雑な統合が不明確な場合
- 技術選定が複数候補ある場合
- パフォーマンス影響が不明な場合
- セキュリティリスクの評価が必要な場合

---

## マスタードキュメントコンテキストの活用

Gap分析時は、以下のマスタードキュメントを参照します：

- `docs/master/structure.md`: システム構造とコンポーネント
- `docs/master/tech.md`: 技術スタックと制約
- `docs/master/product.md`: プロダクト方針とビジネスルール

これにより、プロジェクト全体との整合性を保ちます。

---

## エラーシナリオとフォールバック

### 要件欠落

`requirements.md` が存在しない場合、Gap分析は実施できません。

**対応**:
- エラーメッセージを表示: "最初に `/michi:create-requirements {feature}` を実行して要件を生成してください"
- 処理を停止

### 要件未承認

要件が承認されていない場合でも、Gap分析は実施可能です。

**対応**:
- 警告を表示: "要件が未承認です。Gap分析は要件の改訂を通知する可能性があります"
- 分析を続行

### 空のマスタードキュメントディレクトリ

マスタードキュメントが欠落している場合、分析品質に影響します。

**対応**:
- 警告を表示: "プロジェクトコンテキストが欠落しており、分析品質に影響する可能性があります"
- 可能な範囲で分析を実施

---

**バージョン**: v1.0
**最終更新**: 2026-01-15
