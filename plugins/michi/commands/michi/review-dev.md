---
name: /michi:review-dev
description: 拡張検証付きで要件、設計、タスクに対する実装を検証（Michiバージョン）
allowed-tools: Bash, Glob, Grep, LS, Read, Write, Edit
argument-hint: <feature-name>
---

# Michi: 品質ゲート付き実装検証

<background_information>
- **ミッション**: 実装が承認された要件、設計、タスクに整合していることを検証する
- **成功基準**:
  - 指定されたすべてのタスクが完了としてマーク済み
  - 実装された機能に対してテストが存在し、パスする
  - 要件トレーサビリティが確認（EARS要件がカバー済み）
  - 設計構造が実装に反映されている
  - 既存機能に退行がない
  - Michi 5フェーズ品質ゲートが通過
</background_information>

## 開発ガイドライン
{{DEV_GUIDELINES}}

---

<instructions>
## コアタスク
承認された仕様に基づいて、機能とタスクの実装を検証します。

## 実行手順

### 基本実装

#### 1. 検証対象の検出

**引数が提供されていない場合** (`$1` が空):
- 会話履歴から `/base:spec-impl <feature> [tasks]` コマンドを解析
- 各実行から機能名とタスク番号を抽出
- 実装されたすべてのタスクを機能別に集約
- 検出された実装を報告（例: "user-auth: 1.1, 1.2, 1.3"）
- 履歴が見つからない場合、完了タスク `[x]` を持つ機能のために `{{MICHI_DIR}}/pj/` をスキャン

**機能が提供された場合** (`$1` が存在、`$2` が空):
- 指定された機能を使用
- `{{MICHI_DIR}}/pj/$1/tasks.md` のすべての完了タスク `[x]` を検出

**機能とタスクの両方が提供された場合** (`$1` と `$2` が存在):
- 指定された機能とタスクのみを検証（例: `user-auth 1.1,1.2`）

#### 2. コンテキストの読み込み

各検出された機能について:
- メタデータのために `{{MICHI_DIR}}/pj/<feature>/project.json` を読み取り
- 要件のために `{{MICHI_DIR}}/pj/<feature>/requirements.md` を読み取り
- 設計構造のために `{{MICHI_DIR}}/pj/<feature>/design.md` を読み取り
- タスクリストのために `{{MICHI_DIR}}/pj/<feature>/tasks.md` を読み取り
- **すべてのマスタードキュメントコンテキストを読み込み**: `{{REPO_ROOT_DIR}}/docs/master/` ディレクトリ全体を読み取り（以下を含む）:
  - デフォルトファイル: `structure.md`, `tech.md`, `product.md`
  - すべてのカスタムマスタードキュメントファイル（モード設定に関係なく）

#### 3. 検証の実行

各タスクについて、以下を確認:

**タスク完了チェック**:
- tasks.md でチェックボックスが `[x]` である
- 完了していない場合、"タスクが完了としてマークされていません" とフラグ

**テストカバレッジチェック**:
- タスク関連機能に対するテストが存在する
- テストがパスする（失敗やエラーなし）
- Bash を使用してテストコマンドを実行（例: `npm test`, `pytest`）
- テストが失敗または存在しない場合、"テストカバレッジ問題" とフラグ

**要件トレーサビリティ**:
- タスクに関連するEARS要件を特定
- Grep を使用して要件カバレッジの証拠を実装から検索
- 要件がコードに追跡できない場合、"要件が実装されていません" とフラグ

**設計整合性**:
- design.md の構造が実装に反映されているかチェック
- 主要なインターフェース、コンポーネント、モジュールが存在することを確認
- Grep/LS を使用してファイル構造が設計と一致することを確認
- 不整合が見つかった場合、"設計からの逸脱" とフラグ

**退行チェック**:
- 完全なテストスイートを実行（利用可能な場合）
- 既存のテストが壊れていないことを確認
- 退行が検出された場合、"退行が検出されました" とフラグ

### Michi拡張機能

#### 4. 品質ゲート検証

Michi固有のPhase 6品質ゲートを検証:

```text
Phase 6.2: License & Version Audit
├─ OSS License check
└─ Dependency version check (LTS/EOL)

Phase 6.3: TDD Implementation
├─ Test coverage >= 95%
└─ All tests passing

Phase 6.4: Code Review
├─ PR created
└─ Review comments resolved

Phase 6.5: Coverage Validation
├─ Coverage threshold met
└─ Critical paths covered

Phase 6.8: Archive Preparation
├─ Release notes created
└─ Documentation updated
```

**TDD準拠チェック**:
- 全タスクに対応するテストの存在確認
- テストカバレッジ95%達成確認
- テストファーストの原則遵守確認

**セキュリティチェック**:
- 入力値検証の実装確認
- 認証・認可の実装確認
- セキュアコーディング原則の遵守

#### 5. 拡張レポートの生成

包括的な検証レポートを提供:

```markdown
# Implementation Validation Report: <feature>

## 品質ゲートステータス

### ✅ 合格 (7/10)
- TDD: 全テスト合格 (1022 tests)
- カバレッジ: 96% (目標: 95%)
- ライセンス監査: 全依存関係が準拠
- コードレビュー: PR #166 マージ済み
- ドキュメント: README 更新済み

### ⚠️  警告 (2/10)
- パフォーマンス: 3つの低速クエリを検出
- セキュリティ: APIエンドポイントでレート制限が欠落

### ❌ 失敗 (1/10)
- E2Eテスト: 2つのシナリオが未実装

## 詳細な所見

### 要件準拠
| 要件 | 実装済み | テスト | 備考 |
|-----|---------|-------|------|
| REQ-001 | ✅ | ✅ | 完全 |
| REQ-002 | ✅ | ⚠️ | エッジケーステスト欠落 |
| REQ-003 | ❌ | ❌ | 未実装 |

### 設計準拠
- アーキテクチャ: ✅ Onion Architecture 維持
- APIコントラクト: ✅ 全エンドポイントが設計と一致
- データベーススキーマ: ⚠️ users.email にインデックス欠落

### タスク完了
- 完了: 23/24 タスク
- 残り: タスク 6.4 (E2E tests)

## 推奨事項

### クリティカル（マージ前に修正）
1. REQ-003 を実装
2. 欠落しているE2Eテストシナリオを追加

### 重要（フォローアップPRで修正）
1. users.email にインデックスを追加
2. レート制限を実装
3. 低速クエリを最適化

### オプション
1. REQ-002 のエッジケーステストを追加
```

## 重要な制約
- **会話を認識**: 自動検出のために会話履歴を優先
- **ノンブロッキング警告**: 設計からの逸脱はクリティカルでない限り警告
- **テストファースト重視**: GO決定にはテストカバレッジが必須
- **トレーサビリティ必須**: すべての要件は実装に追跡可能でなければならない
</instructions>

## ツールガイダンス
- **会話解析**: 履歴から `/base:spec-impl` パターンを抽出
- **コンテキスト読み取り**: 検証前にすべての仕様とマスタードキュメントを読み込む
- **テスト用Bash**: テストコマンドを実行してパスステータスを確認
- **トレーサビリティ用Grep**: 要件の証拠をコードベースから検索
- **構造用LS/Glob**: ファイル構造が設計と一致することを確認

## 出力説明

project.json で指定された言語で以下の出力を提供:

### 基本出力

1. **検出された対象**: 検証されている機能とタスク（自動検出された場合）
2. **検証サマリー**: 機能ごとの簡潔な概要（合格/失敗カウント）
3. **問題**: 重要度と場所を含む検証失敗のリスト
4. **カバレッジレポート**: 要件/設計/タスクのカバレッジパーセンテージ
5. **決定**: GO（次のフェーズへの準備完了）/ NO-GO（修正が必要）

### Michi拡張出力

基本出力の後、5フェーズのステータスと推奨事項を含む拡張品質ゲートレポートを追加。

**形式要件**:
- 明確にするためにMarkdownの見出しと表を使用
- クリティカルな問題を ⚠️ または 🔴 でフラグ
- 要約を簡潔に保つ（400語以下）

## 安全性とフォールバック

### エラーシナリオ
- **実装が見つからない**: 履歴に `/base:spec-impl` がなく、`[x]` タスクもない場合、"実装が検出されませんでした" と報告
- **テストコマンド不明**: テストフレームワークが不明確な場合、警告してテスト検証をスキップ（手動検証が必要）
- **仕様ファイル欠落**: project.json/requirements.md/design.md が欠落している場合、エラーで停止
- **言語未定義**: project.json で言語が指定されていない場合、英語（`en`）をデフォルトとする

### 次のステップガイダンス

**GO決定の場合**:
- 実装が検証され準備完了
- デプロイまたは次の機能へ進む

**NO-GO決定の場合**:
- リストされたクリティカルな問題に対処
- 修正のために `/michi:dev <feature> [tasks]` を再実行
- `/michi:review-dev [feature] [tasks]` で再検証

**注意**: 仕様整合性と品質を確保するために、実装後の検証が推奨されます。

---

**Michi統合**: このコマンドは、包括的な実装品質保証のために、5フェーズ品質ゲート、セキュリティチェック、自動化された修正提案で基本実装検証を拡張します。
