---
name: /michi:analyze-gap
description: 詳細レポート付きで要件と既存コードベース間の実装ギャップを分析
allowed-tools: Bash, Glob, Grep, LS, Read, Write, Edit
argument-hint: <feature-name>
---

# Michi: 詳細レポート付きギャップ分析

<background_information>
- **ミッション**: 実装戦略を通知するために、要件と既存コードベース間のギャップを分析する
- **成功基準**:
  - 既存のコードベースパターンとコンポーネントの包括的な理解
  - 欠落している機能と統合課題の明確な特定
  - 複数の実行可能な実装アプローチの評価
  - 設計フェーズのための技術調査ニーズの特定
  - アクション可能な洞察を含む構造化されたレポート（Michi拡張）
</background_information>

## 開発ガイドライン
{{DEV_GUIDELINES}}

---

<instructions>
## コアタスク
承認された要件と既存コードベースに基づいて、機能 **$1** の実装ギャップを分析します。

## 実行手順

### 基本実装

1. **コンテキストの読み込み**:
   - 言語とメタデータのために `{{MICHI_DIR}}/pj/$1/project.json` を読み取り
   - 要件のために `{{MICHI_DIR}}/pj/$1/requirements.md` を読み取り
   - **すべてのマスタードキュメントコンテキストを読み込み**: `{{REPO_ROOT_DIR}}/docs/master/` ディレクトリ全体を読み取り（以下を含む）:
     - デフォルトファイル: `structure.md`, `tech.md`, `product.md`
     - すべてのカスタムマスタードキュメントファイル（モード設定に関係なく）
     - これにより完全なプロジェクトメモリとコンテキストを提供

2. **分析ガイドラインの読み取り**:
   - 包括的な分析フレームワークのために `{{MICHI_DIR}}/settings/rules/gap-analysis.md` を読み取り

3. **ギャップ分析の実行**:
   - 徹底的な調査のために gap-analysis.md フレームワークに従う
   - Grep と Read ツールを使用して既存のコードベースを分析
   - 必要に応じて外部依存関係調査のために WebSearch/WebFetch を使用
   - 複数の実装アプローチ（拡張/新規/ハイブリッド）を評価
   - 出力には project.json で指定された言語を使用

4. **分析ドキュメントの生成**:
   - gap-analysis.md の出力ガイドラインに従って包括的なギャップ分析を作成
   - トレードオフを含む複数の実行可能なオプションを提示
   - さらなる調査が必要な領域にフラグを立てる

### Michi拡張機能

5. **拡張ギャップ分析レポート**:

   Gap分析結果を構造化されたレポートで出力:

   **拡張分析項目**:

   1. **コードカバレッジギャップ**:
      - 要件に対する実装箇所の特定
      - 未実装機能の一覧化
      - 既存コードの再利用可能性評価

   2. **アーキテクチャギャップ**:
      - 設計書との整合性チェック
      - 技術的負債の検出
      - パフォーマンスボトルネックの可能性

   3. **テストギャップ**:
      - テストカバレッジ目標との差異
      - 欠けているテストケース
      - テスト戦略との整合性

   **Gap Analysis Report構造**:

   ```markdown
   # Gap Analysis Report: <feature>

   ## 実行サマリー
   - 総要件数: 15
   - 実装済み: 3
   - 部分実装: 5
   - 未実装: 7
   - ギャップスコア: 47%

   ## 詳細ギャップ

   ### 1. 機能ギャップ
   | 要件ID | ステータス | 実装場所 | 備考 |
   |--------|-----------|---------|------|
   | REQ-001 | ✅ 完了 | src/auth/login.ts:45 | 完全 |
   | REQ-002 | ⚠️ 部分 | src/auth/logout.ts:23 | エラーハンドリング欠落 |
   | REQ-003 | ❌ 欠落 | - | 未実装 |

   ### 2. アーキテクチャギャップ
   - 欠落: データベース移行戦略
   - 不整合: エラーハンドリングアプローチ
   - 技術的負債: auth モジュールのレガシーコード

   ### 3. テストカバレッジギャップ
   - 単体テスト: 45%（目標: 95%）
   - 統合テスト: auth フローで欠落
   - E2Eテスト: 未実装

   ## 推奨事項

   ### 優先度1（クリティカル）
   1. REQ-003, REQ-005 を実装
   2. REQ-002 にエラーハンドリングを追加

   ### 優先度2（重要）
   1. 単体テストカバレッジを95%に増加
   2. レガシー auth コードをリファクタリング

   ### 優先度3（あると良い）
   1. 統合テストを追加
   2. アーキテクチャ決定を文書化
   ```

## 重要な制約
- **決定より情報**: 最終的な実装選択ではなく、分析とオプションを提供
- **複数のオプション**: 該当する場合、実行可能な代替案を提示
- **徹底的な調査**: ツールを使用して既存のコードベースを深く理解
- **明示的なギャップ**: 調査または検討が必要な領域を明確にフラグ付け
</instructions>

## ツールガイダンス
- **最初に読み取り**: 分析前にすべてのコンテキスト（仕様、マスタードキュメント、ルール）を読み込む
- **広範なGrep**: パターン、規約、統合ポイントのためにコードベースを検索
- **WebSearch/WebFetch**: 必要に応じて外部依存関係とベストプラクティスを調査
- **最後に書き込み**: 完全な調査後にのみ分析を生成

## 出力説明

project.json で指定された言語で以下の出力を提供:

### 基本出力

1. **分析サマリー**: スコープ、課題、推奨事項の簡潔な概要（3-5箇条書き）
2. **ドキュメントステータス**: 使用された分析アプローチを確認
3. **次のステップ**: 設計フェーズへの進め方をガイド

### Michi拡張出力

基本出力の後に追加:
- ギャップスコアを含む構造化されたギャップ分析レポート
- 機能/アーキテクチャ/テストカバレッジギャップ表
- 優先順位付けされた推奨事項

**形式要件**:
- 明確にするためにMarkdownの見出しを使用
- 要約を簡潔に保つ（300語以下）
- 詳細な分析は gap-analysis.md の出力ガイドラインに従う

## 安全性とフォールバック

### エラーシナリオ
- **要件欠落**: requirements.md が存在しない場合、メッセージとともに停止: "最初に `/michi:create-requirements $1` を実行して要件を生成してください"
- **要件未承認**: 要件が承認されていない場合、ユーザーに警告するが続行（ギャップ分析は要件の改訂を通知できる）
- **空のマスタードキュメントディレクトリ**: プロジェクトコンテキストが欠落しており、分析品質に影響する可能性があることをユーザーに警告
- **複雑な統合が不明確**: ブロックするのではなく、設計フェーズでの包括的な調査にフラグを立てる
- **言語未定義**: project.json で言語が指定されていない場合、英語（`en`）をデフォルトとする

### 次のフェーズ: 設計生成

**ギャップ分析完了の場合**:
- ギャップ分析の洞察をレビュー
- 技術設計ドキュメントを作成するために `/michi:create-design $1` を実行
- または要件を自動承認して直接進むために `/michi:create-design $1 -y` を実行

**注意**: ギャップ分析はオプションですが、設計決定を通知するためにブラウンフィールドプロジェクトに推奨されます。

---

**Michi統合**: このコマンドは、詳細な構造化されたレポート、ギャップスコアリング、アクション可能な実装計画で基本ギャップ分析を拡張します。
